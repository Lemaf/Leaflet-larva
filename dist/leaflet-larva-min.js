!function(){L.larva={version:"0.1.0",getHeight:function(t){return t.offsetHeight},getWidth:function(t){return t.offsetWidth}},L.larva.handler={},L.larva.handler.Path=L.Handler.extend({includes:[L.Evented.prototype],initialize:function(t,e,a){L.setOptions(this,a),this._path=t,this._frameStyle=e}}),L.Path.addInitHook(function(){this.larva={}}),L.larva.handler.Polyline=L.larva.handler.Path.extend({options:{}}),L.larva.frame={},L.larva.frame.Path=L.Layer.extend({statics:{TOP_LEFT:"tl",TOP_MIDDLE:"tm",TOP_RIGHT:"tr",MIDDLE_LEFT:"ml",MIDDLE_MIDDLE:"mm",MIDDLE_RIGHT:"mr",BOTTOM_LEFT:"bl",BOTTOM_MIDDLE:"bm",BOTTOM_RIGHT:"br"},options:{pane:"llarva-path-frame"},initialize:function(t){this._path=t},beforeAdd:function(t){t.getPane(this.options.pane)||t.createPane(this.options.pane)},getComputedStyle:function(t){return t?this._handles[t]?getComputedStyle(this._handles[t]):void 0:getComputedStyle(this._el)},getEvents:function(){return{zoom:this._onMapZoom}},getDraggable:function(){return this._draggable},getFrameClientRect:function(){return this._el.getBoundingClientRect()},getHandle:function(t){return this._handles[t]},getPosition:function(t){return t?L.DomUtil.getPosition(this._handles[t]):L.DomUtil.getPosition(this._el)},hideHandle:function(){for(var t=0;t<arguments.length;t++)this._handles[arguments[t]]&&(this._handles[arguments[t]].style.display="none")},onAdd:function(){var t=this._el=L.DomUtil.create("div","llarva-pathframe",this.getPane());L.DomEvent.on(t,"mousedown",this._onStart,this),this._handles={},["tl","tm","tr","ml","mm","mr","bl","bm","br"].forEach(function(e){this._handles[e]=L.DomUtil.create("div","llarva-"+e,t),this._handles[e]._id=e,L.DomEvent.on(this._handles[e],L.Draggable.START.join(" "),this._onStart,this)},this),this._draggable=new L.Draggable(t),this._draggables={},this._updateFrame(!1),this._updateHandles()},onRemove:function(){var t;this._draggable&&this._draggable.disable();for(t in this._draggables)this._draggables[t].disable();L.DomEvent.off(this._el,"mousedown click",L.DomEvent.stop);for(t in this._handles)L.DomEvent.off(this._handles[t],"mousedown click",L.DomEvent.stop);L.DomUtil.remove(this._el),L.DomUtil.empty(this._el),delete this._el},setElementStyle:function(t,e){e?(e=this._handles[e],e&&L.extend(e.style,t)):L.extend(this._el.style,t)},setStyle:function(t){var e,a,i=this._style;for(e in this._handles)a=this._handles[e],a.style.display="block",this._draggables[e]&&(this._draggables[e].disable(),delete this._draggables[e]),t[e]&&(t[e].hide&&(a.style.display="none"),t[e].draggable&&(this._draggables[e]=new L.Draggable(a),this._draggables[e].enable(),L.DomEvent.off(a,"mousedown click",L.DomEvent.stop)));i&&L.DomUtil.removeClass(this._el,i.className),L.DomUtil.addClass(this._el,t.className),this._style=t,this._updateHandles();for(e in this._draggables)this._updateDraggable(e)},updateBounds:function(){this._updateFrame(!1,Array.prototype.slice.call(arguments,0))},_onStart:function(t){L.DomEvent.stop(t),this.fire("drag:start",{sourceEvent:t,handle:t.target._id}),L.DomEvent.on(document,L.Draggable.MOVE[t.type],this._onMove,this).on(document,L.Draggable.END[t.type],this._onEnd,this),L.DomUtil.addClass(document.body,"leaflet-dragging")},_onMapZoom:function(){this._updateFrame(!0)},_onMove:function(t){L.DomEvent.stop(t),this.fire("drag:move",{sourceEvent:t})},_onEnd:function(t){L.DomEvent.stop(t);for(var e in L.Draggable.MOVE)L.DomEvent.off(document,L.Draggable.MOVE[e],this._onMove,this).off(document,L.Draggable.END[e],this._onEnd,this);L.DomUtil.removeClass(document.body,"leaflet-dragging"),this.fire("drag:end",{sourceEvent:t})},_updateDraggable:function(t){var e=this._handles[t],a=e.offsetLeft,i=e.offsetTop;e.style.marginLeft&&(a-=parseInt(e.style.marginLeft)),e.style.marginTop&&(i-=parseInt(e.style.marginTop)),L.extend(e.style,{left:"0px",top:"0px"}),L.DomUtil.setPosition(e,L.point(a,i))},_updateFrame:function(t,e){var a,i,n,o=L.DomUtil.getPosition(this._el),s=this._path.getBounds(),r=this._map.latLngToLayerPoint(s.getSouthEast()),h=this._map.latLngToLayerPoint(s.getNorthWest()),l=getComputedStyle(this._el);if(e&&e.length&&o)for(var d=0;d<e.length;d++)i=this._handles[e[d]],i&&(n=L.DomUtil.getPosition(i))&&(n=n.add(o),L.DomUtil.setPosition(i,n.subtract(h)));L.DomUtil.setPosition(this._el,h);var _,g,f=parseInt(l.borderLeftWidth)+parseInt(l.borderRightWidth),m=parseInt(l.borderTopWidth)+parseInt(l.borderBottomWidth);if(t&&(_=this._el.offsetWidth,g=this._el.offsetHeight),this._el.style.width=r.x-h.x-f+"px",this._el.style.height=r.y-h.y-m+"px",t)for(a in this._handles)i=this._handles[a],n=L.DomUtil.getPosition(i),n&&L.DomUtil.setPosition(i,n.scaleBy(L.point(this._el.offsetWidth/_,this._el.offsetHeight/g)));this.southEastPoint=r,this.northWestPoint=h},_updateHandles:function(){var t,e,a,i,n,o,s=L.larva.getWidth,r=L.larva.getHeight;e=getComputedStyle(this._el);var h={bottom:"borderBottomWidth",left:"borderLeftWidth",right:"borderRightWidth",top:"borderTopWidth"};for(var l in h)h[l]=parseInt(e[h[l]])/2;t=this._handles.br,a=-(s(t)/2)-h.right+"px",i=-(r(t)/2)-h.bottom+"px",L.extend(t.style,{right:a,bottom:i}),t=this._handles.bm,n=-(s(t)/2)+"px",i=-(r(t)/2)-h.bottom+"px",L.extend(t.style,{left:"50%","margin-left":n,bottom:i}),t=this._handles.bl,n=-(s(t)/2)-h.left+"px",i=-(r(t)/2)-h.bottom+"px",L.extend(t.style,{left:n,bottom:i}),t=this._handles.mm,n=-(s(t)/2)+"px",o=-(r(t)/2)+"px",L.extend(t.style,{top:"50%",left:"50%","margin-left":n,"margin-top":o}),t=this._handles.ml,o=-(r(t)/2)+"px",n=-(s(t)/2)-h.left+"px",L.extend(t.style,{top:"50%","margin-top":o,left:n}),t=this._handles.mr,a=-(s(t)/2)-h.right+"px",o=-(r(t)/2)+"px",L.extend(t.style,{right:a,top:"50%","margin-top":o}),t=this._handles.tr,a=-(s(t)/2)-h.right+"px",o=-(r(t)/2)-h.top+"px",L.extend(t.style,{right:a,top:o}),t=this._handles.tm,o=-(r(t)/2)-h.top+"px",n=-(s(t)/2)+"px",L.extend(t.style,{left:"50%","margin-left":n,top:o}),t=this._handles.tl,o=-(r(t)/2)-h.top+"px",n=-(s(t)/2)-h.left+"px",L.extend(t.style,{left:n,top:o})}}),L.larva.frame.path=function(t){return t&&t._pathFrame?t._pathFrame:t._pathFrame=new L.larva.frame.Path(t)},L.larva.frame.Style={},L.larva.frame.Style.Resize={className:"llarva-pathframe-resize",mm:{hide:!0}},L.larva.frame.Style.Rotate={className:"llarva-pathframe-rotate",tm:{hide:!0},ml:{hide:!0},mr:{hide:!0},bm:{hide:!0},mm:{draggable:!0}},L.Polyline.prototype.forEachLatLng||L.Polyline.include({forEachLatLng:function(t,e){var a=this.getLatLngs();a.length&&(Array.isArray(a[0])&&(a=a.reduce(function(t,e){return t.concat(e)},[])),a.forEach(t,e))}}),L.Polyline.prototype.updateBounds||L.Polyline.include({updateBounds:function(){var t=this._bounds=new L.LatLngBounds;this.forEachLatLng(function(e){t.extend(e)})}}),L.larva.handler.Polyline.Rotate=L.larva.handler.Polyline.extend({addHooks:function(){this._frame=L.larva.frame.path(this._path),this._frame.addTo(this._path._map),this._frame.setStyle(this._frameStyle),this._frame.on("drag:start",this._onStart,this)},_onEnd:function(){this._frame.off("drag:move",this._onMove,this).off("drag:end",this._onEnd,this)},_onMove:function(t){var e=t.sourceEvent.touches?t.sourceEvent.touches[0]:t.sourceEvent,a=this._centerElement.getBoundingClientRect(),i=a.left+a.width/2,n=a.top+a.height/2,o=e.clientX-i,s=e.clientY-n,r=Math.sqrt(o*o+s*s),h=(this._vector.i*s-this._vector.j*o)/r,l=(this._vector.i*o+this._vector.j*s)/r,d=this._frame.getFrameClientRect(),_=this._frame.getPosition();i=i-d.left+_.x,n=n-d.top+_.y;var g,f,m=i*(1-l)+n*h,c=n*(1-l)-i*h,u=L.point(0,0);this._path.forEachLatLng(function(t){g=this._path._map.latLngToLayerPoint(t._original),u.x=g.x*l-g.y*h+m,u.y=g.x*h+g.y*l+c,f=this._path._map.layerPointToLatLng(u),t.lat=f.lat,t.lng=f.lng},this),this._path.updateBounds(),this._frame.updateBounds(L.larva.frame.Path.MIDDLE_MIDDLE),this._path.redraw()},_onStart:function(t){if(t.handle&&t.handle!==L.larva.frame.Path.MIDDLE_MIDDLE){var e=this._centerElement=this._frame.getHandle(L.larva.frame.Path.MIDDLE_MIDDLE),a=e.getBoundingClientRect(),i=t.sourceEvent.target.getBoundingClientRect(),n=this._vector={i:i.left+i.width/2-(a.left-a.width/2),j:i.top+i.height/2-(a.top-a.height/2)};n.length=Math.sqrt(n.i*n.i+n.j*n.j),n.i=n.i/n.length,n.j=n.j/n.length,this._path.forEachLatLng(function(t){t._original=t.clone()}),this._frame.on("drag:move",this._onMove,this).on("drag:end",this._onEnd,this)}}}),L.Polyline.addInitHook(function(){this.larva.rotate=new L.larva.handler.Polyline.Rotate(this,L.larva.frame.Style.Rotate)}),L.larva.handler.Polyline.Move=L.larva.handler.Polyline.extend({addHooks:function(){this._frame=L.larva.frame.path(this._path).addTo(this._path._map),this._frame.on("drag:start",this._onStart,this),this._previousCursor=this._frame.getComputedStyle().cursor,this._frame.setElementStyle({cursor:"move"})},_onEnd:function(){this._frame.off("drag:move",this._onMove,this).off("drag:end",this._onEnd)},_onMove:function(t){var e=t.sourceEvent.touches?t.sourceEvent.touches:t.sourceEvent,a=e.clientX-this._startPosition.x,i=e.clientY-this._startPosition.y;if(e.ctrlKey&&e.altKey){var n=Math.min(Math.abs(a),Math.abs(i));a=a>=0?n:-n,i=i>=0?n:-n}else e.ctrlKey?i=null:e.altKey&&(a=null);var o,s;this._path.forEachLatLng(function(t){o=this._path._map.latLngToLayerPoint(t._original),a&&(o.x+=a),i&&(o.y+=i),s=this._path._map.layerPointToLatLng(o),t.lat=s.lat,t.lng=s.lng},this),this._path.updateBounds(),this._frame.updateBounds(),this._path.redraw()},_onStart:function(t){if(!t.handle){this._path.forEachLatLng(function(t){t._original=t.clone()});var e=t.sourceEvent.touches?t.sourceEvent.touches[0]:t.sourceEvent;this._startPosition={x:e.clientX,y:e.clientY},this._frame.on("drag:move",this._onMove,this).on("drag:end",this._onEnd,this)}}}),L.Polyline.addInitHook(function(){this.larva.move=new L.larva.handler.Polyline.Move(this,L.larva.frame.Style.Move)}),L.larva.handler.Polygon=L.larva.handler.Polyline.extend({}),L.larva.handler.Polyline.Resize=L.larva.handler.Polyline.extend({addHooks:function(){this._frame=L.larva.frame.path(this._path).addTo(this._path._map),this._frame.setStyle(this._frameStyle),this._frame.on("drag:start",this._onStart,this)},_onEnd:function(){this._frame.off("drag:move",this._onMove,this).off("drag:end",this._onEnd,this),delete this._origin},_onMove:function(t){var e=t.sourceEvent.touches?t.sourceEvent.touches[0]:t.sourceEvent,a=null,i=null;if(void 0!==this._origin.screenX&&(a=(e.clientX-this._origin.screenX)/this._origin.width),void 0!==this._origin.screenY&&(i=(e.clientY-this._origin.screenY)/this._origin.height),null!==a||null!==i){if(null!==a&&null!==i&&t.sourceEvent.ctrlKey){var n=Math.max(Math.abs(a),Math.abs(i));a=a>=0?n:-n,i=i>=0?n:-n,this._origin.invertX&&(a=-a),this._origin.invertY&&(i=-i)}var o,s;this._path.forEachLatLng(function(t){o=this._path._map.latLngToLayerPoint(t._original),null!==a&&(this._origin.invertX?o.x=this._origin.x-o.x:o.x=o.x-this._origin.x,o.x=o.x*a+this._origin.x),null!==i&&(this._origin.invertY?o.y=this._origin.y-o.y:o.y=o.y-this._origin.y,o.y=o.y*i+this._origin.y),s=this._path._map.layerPointToLatLng(o),t.lat=s.lat,t.lng=s.lng},this),this._path.updateBounds(),this._frame.updateBounds(),this._path.redraw()}},_onStart:function(t){this._path.forEachLatLng(function(t){t._original=t.clone()});var e=this._frame.getFrameClientRect(),a=this._origin={height:e.height,width:e.width},i=this._frame.getPosition();switch(t.handle){case L.larva.frame.Path.TOP_LEFT:a.x=i.x+e.width,a.y=i.y+e.height,a.screenX=e.right,a.screenY=e.bottom,a.invertX=!0,a.invertY=!0;break;case L.larva.frame.Path.TOP_MIDDLE:a.y=i.y+e.height,a.screenY=e.bottom,a.invertY=!0;break;case L.larva.frame.Path.TOP_RIGHT:a.x=i.x,a.y=i.y+e.height,a.screenX=e.left,a.screenY=e.bottom,a.invertY=!0;break;case L.larva.frame.Path.MIDDLE_LEFT:a.x=i.x+e.width,a.screenX=e.right,a.invertX=!0;break;case L.larva.frame.Path.MIDDLE_RIGHT:a.x=i.x,a.screenX=e.left;break;case L.larva.frame.Path.BOTTOM_LEFT:a.x=i.x+e.width,a.y=i.y,a.screenX=e.right,a.screenY=e.top,a.invertX=!0;break;case L.larva.frame.Path.BOTTOM_MIDDLE:a.y=i.y,a.screenY=e.top;break;case L.larva.frame.Path.BOTTOM_RIGHT:a.x=i.x,a.y=i.y,a.screenY=e.top,a.screenX=e.left}this._frame.on("drag:move",this._onMove,this).on("drag:end",this._onEnd,this)}}),L.Polyline.addInitHook(function(){this.larva.resize=new L.larva.handler.Polyline.Resize(this,L.larva.frame.Style.Resize)})}();